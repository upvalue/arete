<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Arete</title>
    <style>
      html {
        margin: 0;
        padding: 0;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: arial;
      }

      .emscripten { padding-right: 0; margin-left: auto; margin-right: auto; display: block; }
      div.emscripten { text-align: center; }      
      div.emscripten_border { border: 1px solid black; }
      /* the canvas *must not* have any border or padding, or mouse coords will be wrong */
      canvas.emscripten { border: 0px none; background-color: black; }

      #status {
        display: inline-block;
        vertical-align: top;
        margin-top: 30px;
        margin-left: 20px;
        font-weight: bold;
        color: rgb(120, 120, 120);
      }

      #progress {
        height: 20px;
        width: 30px;
      }

      #controls {
        display: inline-block;
        float: right;
        vertical-align: top;
        margin-top: 30px;
        margin-right: 20px;
      }

      #output {
        width: 100%;
        height: 200px;
        margin: 0 auto;
        margin-top: 10px;
        border-left: 0px;
        border-right: 0px;
        padding-left: 0px;
        padding-right: 0px;
        display: block;
        background-color: black;
        color: white;
        font-family: 'Lucida Console', Monaco, monospace;
        outline: none;
      }

      .arete-root input, button {
        width:100%;
        padding: 5px;
        border: 1px solid #ccc;
        background-color: #eee;
        display: block;
        margin-bottom: 5px;
      }

      input, button, .arete-repl {
        font-family: Consolas, Monaco, monospace;
        font-size: 12px;
      }

      .arete-repl {
        padding: 5px;
        width: 100%;
        background-color: #eee;
        min-height: 300px;
      }
    </style>
  </head>
  <body>
    <!--
    <div class="emscripten" id="status">Downloading...</div>
<span id='controls'>
  <span><input type="checkbox" id="resize">Resize canvas</span>
  <span><input type="checkbox" id="pointerLock" checked>Lock/hide mouse pointer &nbsp;&nbsp;&nbsp;</span>
  <span><input type="button" value="Fullscreen" onclick="Module.requestFullscreen(document.getElementById('pointerLock').checked, 
                                                                            document.getElementById('resize').checked)">
  </span>
</span>

    <div class="emscripten">
      <progress value="0" max="100" id="progress" hidden=1></progress>
    </div>

    
    <div class="emscripten_border">
      <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()"></canvas>
    </div>
    <textarea id="output" rows="8"></textarea>

  -->

<div id="arete-root"></div>
<script src="//unpkg.com/preact/dist/preact.min.js"></script>

<script type='text/javascript'>
var statusElement = document.getElementById('status');
var progressElement = document.getElementById('progress');
var spinnerElement = document.getElementById('spinner');

const h = preact.h;
let setState, getState;

class AreteInterface extends preact.Component {
  constructor() {
    super();
    setState = (state) => {
      console.log('state update', state);
      this.setState(state);
      this.forceUpdate();
    }
    getState = () => this.state;
    this.state = {
      dependenciesLeft: 0,
      dependenciesTotal: 1,
      message: false,
      consoleLines: [],
    }
  }

  enterLine(e) {
    e.preventDefault();
    // Module.ccall('ar_init', null, ['number'], [this.r.value]);
    Module.ccall('ar_eval_and_print', null, ['string', 'string'], ['heap32.boot', this.r.value]);
    this.r.value = '';
  }

  render(props, state) {
    return h('div', { class: 'arete-root' },
      state.dependenciesLeft != state.dependenciesTotal &&
        h('p', null, `Loading: ${state.dependenciesLeft} / ${state.dependenciesTotal}.`),
      state.message && h('p', null, `${state.message ? state.message : ''}`),
      h('pre', { class: 'arete-repl' }, ...
        this.state.consoleLines.slice(-100).map((line) =>  {
          return line;
        }),
      ),
      h('form', { onSubmit: (e) => this.enterLine(e) },
        h('input', { class: 'arete-cmd', type: 'text', ref: (r) => { this.r = r; }, placeholder: 'Enter scheme code...', }),
        h('button', { type: 'submit' }, '=>'),
      )
    );
  }
}

document.addEventListener('DOMContentLoaded', () => {
  preact.render(h(AreteInterface), document.getElementById('arete-root'));
});

const printLine = (text, error) => {
  const lines = getState().consoleLines;
  lines.push(`${text}\n`);
  setState({
    consoleLines: lines,
  });
  (error ? console.error : console.log)(text);
}

window.Module = {
  arguments: ['-'],
  preRun: [],
  postRun: [],
  TOTAL_STACK: 16777216,
  TOTAL_MEMORY: 16777216 * 2,

  print: (text) => printLine(text, false),
  printErr: (text) => printLine(text, true),

  canvas: (function() {
    var canvas = document.getElementById('canvas');
    //canvas.addEventListener("webglcontextlost", function(e) { alert('WebGL context lost. You will need to reload the page.'); e.preventDefault(); }, false);
    return canvas;
  })(),

  setStatus: function(text) {
    setState({ message: text });
  },

  monitorRunDependencies: function(left) {
    let total = Math.max(getState().dependenciesTotal || 0, left);
    setState({
      dependenciesLeft: total - left,
      dependenciesTotal: total,
    });
  }
};

window.onerror = function(event) {
  // TODO: do not warn on ok events like simulating an infinite loop or exitStatus
  Module.setStatus('Exception thrown, see JavaScript console');
  Module.setStatus = function(text) {
    if (text) Module.printErr('[post-exception status] ' + text);
  };
};
</script>
<script type="text/javascript">

        (function() {
          var memoryInitializer = 'arete.js.mem';
          if (typeof Module['locateFile'] === 'function') {
            memoryInitializer = Module['locateFile'](memoryInitializer);
          } else if (Module['memoryInitializerPrefixURL']) {
            memoryInitializer = Module['memoryInitializerPrefixURL'] + memoryInitializer;
          }
          var meminitXHR = Module['memoryInitializerRequest'] = new XMLHttpRequest();
          meminitXHR.open('GET', memoryInitializer, true);
          meminitXHR.responseType = 'arraybuffer';
          meminitXHR.send(null);
        })();

        var script = document.createElement('script');
        script.src = "arete.js";
        document.body.appendChild(script);
  </script>
</body>
</html>
